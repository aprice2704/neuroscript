# NeuroData Table Format (.ndtable) Specification

:: type: TableFormatSpec
:: version: 0.1.0
:: status: draft
:: dependsOn: docs/metadata.md, docs/neurodata_and_composite_file_spec.md, docs/script spec.md
:: howToUpdate: Review schema definitions, validation rules, data format, EBNF, and examples. Update planned features (NS fragments).

## 1. Purpose

NeuroData Tables (`.ndtable`) provide a simple, human-readable plain-text format for representing tabular data, similar to simple SQL tables or CSV files but with an explicitly defined schema and validation rules embedded within the file. This format is intended for storing hundreds or thousands of rows for simple lookup and CRUD (Create, Read, Update, Delete) operations, primarily by tools and AI, while remaining easily inspectable by humans. Joins between tables are not an explicit design goal for this format.

## 2. Syntax

A `.ndtable` file consists of the following sections in order:
1.  **File-Level Metadata:** Optional `:: key: value` lines [cite: uploaded:neuroscript/docs/metadata.md].
2.  **Schema Definition:** Zero or more `COLUMN` definition lines defining the table structure and constraints.
3.  **Data Separator:** A line containing exactly `--- DATA ---` to mark the end of the schema and the beginning of data rows.
4.  **Data Rows:** Zero or more lines representing the table data, with columns delimited by a specific character (pipe `|`).

Comments (`#` or `--`) and blank lines can appear before the Schema Definition and between `COLUMN` lines. They are generally ignored within the Data Rows section, unless a specific tool interprets commented-out data rows.

### 2.1 File-Level Metadata

Standard `:: key: value` lines [cite: uploaded:neuroscript/docs/metadata.md]. Recommended metadata includes:
* `:: type: Table` (Required)
* `:: version: <semver>` (Required)
* `:: id: <unique_table_id>` (Optional)
* `:: primaryKey: <column_name>` (Optional, indicates the primary key column)
* `:: description: <text>` (Optional)

### 2.2 Schema Definition Section

This section defines the columns, their types, and validation rules.
* Format: `COLUMN column_name data_type [validation_rules...]`
* `COLUMN`: Keyword.
* `column_name`: Identifier for the column (`[a-zA-Z_][a-zA-Z0-9_]*`). Must be unique within the table.
* `data_type`: Specifies the expected data type. Supported types:
    * `string`: Text data.
    * `int`: 64-bit signed integer.
    * `float`: 64-bit floating-point number.
    * `bool`: Boolean (`true` or `false`).
    * `timestamp`: ISO 8601 format timestamp string (e.g., `2024-01-15T10:00:00Z`).
    * `enum("value1", "value2", ...)`: String restricted to one of the specified quoted values.
* `[validation_rules...]`: Optional space-separated validation keywords and arguments:
    * `NOT NULL`: The column cannot contain an empty value.
    * `UNIQUE`: The value in this column must be unique across all rows in the table.
    * `REGEX("pattern")`: The string value must match the provided Go regular expression pattern.
    * `MIN(value)`: The numeric/timestamp value must be greater than or equal to `value`.
    * `MAX(value)`: The numeric/timestamp value must be less than or equal to `value`.
    * `DEFAULT(value)`: Specifies a default value if none is provided on insert. The `value` should be interpretable as the column's `data_type` (e.g., `DEFAULT(0)`, `DEFAULT("pending")`, `DEFAULT(true)`). `DEFAULT(NOW)` is a special value for `timestamp` columns, indicating the current time on insert/update.

### 2.3 NeuroScript Fragment Rules (Planned for Future Versions)

*(Note: The following rules using `VALIDATE_NS` and `DEFAULT_NS`/`GENERATE_NS` are planned features and not part of the v0.1.0 specification. They are included here for design context.)*
* `VALIDATE_NS("neuroscript_expression")`: (Future) The string value must satisfy the NeuroScript expression, which should evaluate to `true`. The expression can use `{{value}}` to refer to the value being validated. Example: `VALIDATE_NS("{{value}} >= 0 AND {{value}} < 100")`.
* `DEFAULT_NS("neuroscript_expression")`: (Future) Uses the result of the NeuroScript expression as the default value. Example: `DEFAULT_NS("CALL TOOL.GenerateUUID()")`.
* `GENERATE_NS("neuroscript_expression")`: (Future) The value for this column is *always* generated by the NeuroScript expression, potentially using other row values via `{{row.column}}`. Example: `GENERATE_NS("'{{row.first}}' + ' ' + '{{row.last}}'")`.

### 2.4 Data Separator

A single line containing exactly `--- DATA ---` MUST follow the last Schema Definition line (or metadata if no schema).

### 2.5 Data Rows Section

* Each line represents one row in the table.
* Columns are separated by the pipe character (`|`). Leading/trailing whitespace around the pipe delimiter AND within a cell is significant unless tools specifically trim it.
* The number of delimiters should correspond to the number of columns defined in the schema (i.e., `num_columns - 1` pipe characters).
* **Escaping:**
    * To include a literal pipe character (`|`) within a cell's data, it should be escaped as `\|`.
    * To include a literal backslash (`\`) within a cell's data, it should be escaped as `\\`.
    * Newlines within cell data are generally discouraged for simplicity. If needed, they could be represented by `\n` (literal backslash-n), requiring tools to interpret this sequence during read/write. Representing actual multi-line text is better handled using attached data blocks or separate notes fields.
* **Null/Empty vs. Default:** An empty string between delimiters (e.g., `value1||value3`) represents an empty/null value for the second column. If a `DEFAULT` rule exists for that column, tools should apply it during insertion if the value is empty.

## 3. EBNF Grammar (Draft)

```ebnf
table_file        ::= { metadata_line | comment_line | blank_line }
                    schema_section
                    data_separator newline
                    data_section ;

metadata_line     ::= optional_whitespace "::" whitespace key ":" value newline ; (* As per graph spec *)
schema_section      ::= { column_definition | comment_line | blank_line } ;
column_definition ::= optional_whitespace "COLUMN" whitespace column_name whitespace data_type { whitespace validation_rule } newline ;
column_name       ::= identifier ;
data_type         ::= "string" | "int" | "float" | "bool" | "timestamp" | enum_definition ;
enum_definition    ::= "enum(" quoted_string { "," quoted_string } ")" ;
validation_rule   ::= "NOT" whitespace "NULL" | "UNIQUE" | regex_rule | minmax_rule | default_rule | ns_validation_rule ; (* ns_* are future *)
regex_rule        ::= "REGEX(" quoted_string ")" ;
minmax_rule       ::= ("MIN" | "MAX") "(" simple_value ")" ;
default_rule      ::= "DEFAULT(" (simple_value | "NOW") ")" ;
ns_validation_rule::= "VALIDATE_NS(" quoted_string ")" ; (* Future *)

data_separator    ::= optional_whitespace "--- DATA ---" optional_whitespace ;

data_section      ::= { data_row } ;
data_row          ::= cell_value { optional_whitespace "|" optional_whitespace cell_value } newline ;
cell_value        ::= { character_except_pipe_or_newline | escaped_pipe | escaped_backslash | escaped_newline } ; (* Needs refinement *)

(* Define: identifier, key, value, rest_of_line, quoted_string, simple_value, number_literal, boolean_literal, whitespace, newline, comment_line, blank_line, escaped_pipe, escaped_backslash, escaped_newline *)
```

## 4. Tool Interaction (CRUD)

Tools interacting with `.ndtable` files (e.g., `TOOL.ReadTable`, `TOOL.InsertRow`, `TOOL.UpdateRow`, `TOOL.DeleteRow`) should:
1.  Parse the schema section first.
2.  Validate data during `InsertRow` and `UpdateRow` operations against the defined `data_type` and `validation_rules`.
3.  Apply `DEFAULT` values during `InsertRow` if a column value is missing or empty.
4.  Enforce `UNIQUE` constraints.
5.  Handle escaping/unescaping of `|`, `\`, and potentially `\n` when reading/writing data rows.
6.  (Future) Execute `VALIDATE_NS` fragments during validation and `DEFAULT_NS`/`GENERATE_NS` during row creation/modification.

## 5. Example

```ndtable
:: type: Table
:: version: 0.1.0
:: primaryKey: user_id
:: description: Example user table.

# Schema
COLUMN user_id  int     NOT NULL UNIQUE MIN(1)
COLUMN name     string  NOT NULL REGEX("^[A-Za-z ]+$")
COLUMN email    string  UNIQUE
COLUMN status   enum("active", "inactive", "pending") DEFAULT("pending")
COLUMN created  timestamp DEFAULT(NOW)
# COLUMN score    int     DEFAULT(0) VALIDATE_NS("{{value}} >= 0") # Future Example

--- DATA ---
1 | Alice | alice@example.com | active | 2024-01-15T10:00:00Z
2 | Bob   | bob@example.com   |        | 2024-01-16T11:30:00Z
3 | Charlie | charlie@test.com | active | 2024-02-01T09:00:00Z
4 | David | david@domain.org | pending | 2024-03-10T15:45:10Z
5 | Eve   | eve@domain.org    | inactive| 2024-03-11T16:00:00Z
```

You can copy this into `docs/neurodata/table.md`. Let me know your thoughts!